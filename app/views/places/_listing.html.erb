<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<% unless smart_listing.empty? %>
  
  <div class="col-md-4 col-md-push-8 text-center space-to-bottom-20">
    <div id="map" style='width: 100%; height: 300px;'></div>
  </div>

  <div id="test" class="col-md-8 col-md-pull-4">
    <% smart_listing.collection.each_with_index do |place, index| %>
      <ul class="places">
        <li>
          <div class="row">
            <div class="col-xs-7">
              <%= image_tag place.primary_image.url, :class => "hidden-xs" %>
                <strong><%= index + 1 %> <%= link_to place.name, place %></strong>
                <% if params[:search].present? %>
                  <%= "(" + place.distance_from(@location).round(2).to_s + " miles)" %>
                <% end %><br>
                <%= place.category_list %><br>
                <address>
                  <%= place.address_line_1 %>
                    <% if !place.address_line_2.empty? %>
                      <%= ', ' + place.address_line_2 %>   
                    <% end %>
                    <%= tag(:br) %>
                    <%= place.address_city %>, <%= place.address_state %> <%= place.address_zip_code %><br>
                  <%= place.phone_number %><br>
                  <%= link_to "website", "http://#{place.url_website}"%><%= ", " %>
                  <%= link_to "menu", "http://#{place.url_menu}"%>
                </address>
            </div>
            <div class="place-list-right text-right">
              <div id=<%= "star_" + place.id.to_s %>></div>
              <div class="text" class="text-right">
                (<%= pluralize(place.reviews.count, 'review') %>)<br><br>
              </div>
            </div>
          </div>
        </li>
      </ul> 

      <script type="text/javascript">
        $('#star_<%= place.id.to_s %>').raty({
          readOnly: true,
          score: <%= place.rating %>,
          path: '/assets'
        });
      </script>
    <% end %>

    <%= smart_listing.paginate %>
    <%= smart_listing.pagination_per_page_links %>
  </div>

<% else %>
  <%= "Nothing" %>
<% end %>

<script type="text/javascript">
  handler = Gmaps.build('Google');
  handler.buildMap({
    provider: {
    },
    internal: {
      id: 'map'
    }
  },
  function(){
    markers = handler.addMarkers(<%=raw @hash.to_json %>);
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
    <%= "handler.getMap().setZoom(12);" if smart_listing.count == 1 %>
  });
</script>